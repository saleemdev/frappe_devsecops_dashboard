{"version":3,"file":"erpnextApiUtils-BWev8WNC.js","sources":["../../../../frontend/src/utils/erpnextApiUtils.js"],"sourcesContent":["/**\n * ERPNext API Utilities for DevSecOps Dashboard\n * Integrates with ERPNext Project and Task Type doctypes\n */\n\nimport axios from 'axios'\n\n// API base configuration\nconst API_BASE = '/api/method'\n\n// Create axios instance with default config\nconst apiClient = axios.create({\n  baseURL: API_BASE,\n  timeout: 30000,\n  headers: {\n    'Content-Type': 'application/json',\n    'X-Frappe-CSRF-Token': window.csrf_token || ''\n  }\n})\n\n// Request interceptor to add CSRF token and handle headers\napiClient.interceptors.request.use(\n  (config) => {\n    // Add CSRF token if available\n    if (window.csrf_token) {\n      config.headers['X-Frappe-CSRF-Token'] = window.csrf_token\n    }\n\n    // Ensure proper headers for API requests\n    config.headers['Accept'] = 'application/json'\n    config.headers['Content-Type'] = 'application/json'\n\n    // Remove Expect header to avoid 417 errors\n    delete config.headers['Expect']\n\n    return config\n  },\n  (error) => {\n    return Promise.reject(error)\n  }\n)\n\n// Response interceptor for error handling\napiClient.interceptors.response.use(\n  (response) => {\n    return response\n  },\n  (error) => {\n    return Promise.reject(error)\n  }\n)\n\n/**\n * Get comprehensive dashboard data from ERPNext Project and Task Type integration\n * @returns {Promise<Object>} Dashboard data with projects, metrics, and lifecycle phases\n */\nexport const getDashboardData = async () => {\n  try {\n    const response = await apiClient.get('frappe_devsecops_dashboard.api.dashboard.get_dashboard_data')\n\n    if (response.data && response.data.message) {\n      const data = response.data.message\n\n      // Transform data to ensure consistent field naming\n      return {\n        success: data.success || false,\n        projects: transformProjectsData(data.projects || []),\n        metrics: transformMetricsData(data.metrics || {}),\n        lifecycle_phases: data.lifecycle_phases || [],\n        timestamp: data.timestamp\n      }\n    }\n\n    throw new Error('Invalid response format')\n\n  } catch (error) {\n    // Return fallback data structure\n    return {\n      success: false,\n      error: error.message || 'Failed to fetch dashboard data',\n      projects: [],\n      metrics: {\n        total_projects: 0,\n        active_projects: 0,\n        total_tasks: 0,\n        completed_tasks: 0,\n        average_completion: 0,\n        team_capacity: 0,\n        completion_rate: 0\n      },\n      lifecycle_phases: []\n    }\n  }\n}\n\n/**\n * Get detailed information for a specific project\n * @param {string} projectName - Name of the project\n * @returns {Promise<Object>} Detailed project information\n */\nexport const getProjectDetails = async (projectName) => {\n  try {\n    const response = await apiClient.get('frappe_devsecops_dashboard.api.dashboard.get_project_details', {\n      params: { project_name: projectName }\n    })\n\n    if (response.data && response.data.message) {\n      const data = response.data.message\n\n      if (data.success) {\n        return {\n          success: true,\n          project: transformProjectData(data.project)\n        }\n      } else {\n        throw new Error(data.error || 'Failed to fetch project details')\n      }\n    }\n\n    throw new Error('Invalid response format')\n\n  } catch (error) {\n    return {\n      success: false,\n      error: error.message || 'Failed to fetch project details',\n      project: null\n    }\n  }\n}\n\n/**\n * Transform projects data to ensure consistent field naming and structure\n * @param {Array} projects - Raw projects data from API\n * @returns {Array} Transformed projects data\n */\nconst transformProjectsData = (projects) => {\n  return projects.map(project => transformProjectData(project))\n}\n\n/**\n * Transform individual project data\n * @param {Object} project - Raw project data\n * @returns {Object} Transformed project data\n */\nconst transformProjectData = (project) => {\n  return {\n    // Core project fields\n    id: project.id || project.name,\n    name: project.name || project.project_name || 'Unnamed Project',\n    project_name: project.project_name || project.name,\n    project_status: project.project_status || project.status || 'Open',\n    status: project.status || project.project_status || 'Open',\n\n    // Client and type information\n    client: project.client || project.customer || 'No Client',\n    customer: project.customer || project.client,\n    project_type: project.project_type || 'Standard',\n    priority: project.priority || 'Medium',\n\n    // Progress and metrics\n    progress: parseFloat(project.progress || project.percent_complete || 0),\n    percent_complete: parseFloat(project.percent_complete || project.progress || 0),\n    completion_rate: parseFloat(project.completion_rate || 0),\n\n    // Task information\n    task_count: parseInt(project.task_count || 0),\n    total_tasks: parseInt(project.total_tasks || project.task_count || 0),\n    completed_tasks: parseInt(project.completed_tasks || 0),\n\n    // Phase information\n    current_phase: project.current_phase || 'Planning',\n    currentPhase: project.currentPhase || project.current_phase || 'Planning',\n\n    // Delivery phases (ERPNext Task Type based)\n    delivery_phases: transformDeliveryPhases(project.delivery_phases || []),\n    deliveryPhases: transformDeliveryPhases(project.delivery_phases || []),\n\n    // Date fields\n    expected_start_date: project.expected_start_date,\n    expected_end_date: project.expected_end_date,\n    actual_start_date: project.actual_start_date,\n    actual_end_date: project.actual_end_date,\n\n    // Organizational fields\n    cost_center: project.cost_center,\n    department: project.department,\n\n    // Custom fields - Software Product and RACI Template\n    custom_software_product: project.custom_software_product || null,\n    custom_default_raci_template: project.custom_default_raci_template || null,\n    custom_zenhub_workspace_id: project.custom_zenhub_workspace_id || null,\n\n    // Tasks array for detailed view\n    tasks: project.tasks || []\n  }\n}\n\n/**\n * Transform delivery phases data\n * @param {Array} phases - Raw phases data\n * @returns {Array} Transformed phases data\n */\nconst transformDeliveryPhases = (phases) => {\n  return phases.map(phase => ({\n    // New ERPNext-based fields\n    section_id: phase.section_id,\n    section_name: phase.section_name || phase.name,\n    section_status: phase.section_status || phase.status,\n    section_progress: parseFloat(phase.section_progress || phase.progress || 0),\n    section_order: parseInt(phase.section_order || 0),\n\n    // Task counts\n    task_count: parseInt(phase.task_count || 0),\n    completed_tasks: parseInt(phase.completed_tasks || 0),\n    in_progress_tasks: parseInt(phase.in_progress_tasks || 0),\n\n    // Legacy fields for backward compatibility\n    name: phase.name || phase.section_name,\n    status: phase.status || phase.section_status,\n    progress: parseFloat(phase.progress || phase.section_progress || 0)\n  }))\n}\n\n/**\n * Transform metrics data\n * @param {Object} metrics - Raw metrics data\n * @returns {Object} Transformed metrics data\n */\nconst transformMetricsData = (metrics) => {\n  return {\n    // Project counts\n    total_projects: parseInt(metrics.total_projects || 0),\n    active_projects: parseInt(metrics.active_projects || 0),\n    activeProjects: parseInt(metrics.active_projects || metrics.activeProjects || 0),\n\n    // Task counts\n    total_tasks: parseInt(metrics.total_tasks || 0),\n    totalTasks: parseInt(metrics.total_tasks || metrics.totalTasks || 0),\n    completed_tasks: parseInt(metrics.completed_tasks || 0),\n    completedTasks: parseInt(metrics.completed_tasks || metrics.completedTasks || 0),\n\n    // Progress metrics\n    average_completion: parseFloat(metrics.average_completion || 0),\n    completion_rate: parseFloat(metrics.completion_rate || 0),\n\n    // Team metrics\n    team_capacity: parseFloat(metrics.team_capacity || 0),\n    teamCapacity: parseFloat(metrics.team_capacity || metrics.teamCapacity || 0)\n  }\n}\n\n/**\n * Get ERPNext Task Types for lifecycle phases\n * @returns {Promise<Array>} List of Task Types\n */\nexport const getTaskTypes = async () => {\n  try {\n    const response = await apiClient.get('/api/resource/Task Type')\n\n    if (response.data && response.data.data) {\n      return response.data.data.map(taskType => ({\n        name: taskType.name,\n        description: taskType.description || `${taskType.name} phase`\n      }))\n    }\n\n    return []\n\n  } catch (error) {\n    return []\n  }\n}\n\n/**\n * Get ERPNext Projects list\n * @returns {Promise<Array>} List of Projects\n */\nexport const getProjects = async () => {\n  try {\n    const response = await apiClient.get('/api/resource/Project', {\n      params: {\n        fields: JSON.stringify(['name', 'project_name', 'status', 'customer', 'percent_complete']),\n        filters: JSON.stringify([['disabled', '=', 0]])\n      }\n    })\n\n    if (response.data && response.data.data) {\n      return response.data.data\n    }\n\n    return []\n\n  } catch (error) {\n    return []\n  }\n}\n\n/**\n * Get tasks for a specific project with Task Type information\n * @param {string} projectId - Project ID or name\n * @returns {Promise<Array>} List of tasks with task_type field\n */\nexport const getProjectTasksWithTypes = async (projectId) => {\n  try {\n    // Query ERPNext Task doctype for tasks belonging to this project\n    const response = await apiClient.get('/api/resource/Task', {\n      params: {\n        fields: JSON.stringify([\n          'name',\n          'subject',\n          'status',\n          'priority',\n          'project',\n          'task_type',\n          'exp_start_date',\n          'exp_end_date',\n          '_assign',\n          'description'\n        ]),\n        filters: JSON.stringify([\n          ['project', '=', projectId]\n        ]),\n        limit_page_length: 999\n      }\n    })\n\n    if (response.data && response.data.data) {\n      const tasks = response.data.data.map(task => ({\n        id: task.name,\n        name: task.name,\n        subject: task.subject,\n        status: task.status,\n        priority: task.priority,\n        project: task.project,\n        task_type: task.task_type,\n        due_date: task.exp_end_date,\n        start_date: task.exp_start_date,\n        assigned_to: task._assign ? JSON.parse(task._assign)[0] : null,\n        description: task.description\n      }))\n\n      return tasks\n    }\n\n    return []\n\n  } catch (error) {\n    return []\n  }\n}\n\n// Export the main function for backward compatibility\nexport const getProjectsWithTasks = getDashboardData\n\n/**\n * Create API client for use in other modules\n * Returns the configured axios instance\n */\nexport const createApiClient = async () => {\n  return apiClient\n}\n\n// Default export\nexport default {\n  getDashboardData,\n  getProjectDetails,\n  getTaskTypes,\n  getProjects,\n  getProjectsWithTasks: getDashboardData,\n  getProjectTasksWithTypes,\n  createApiClient\n}\n"],"names":["API_BASE","apiClient","axios","config","error","response","getDashboardData","data","transformProjectsData","transformMetricsData","getProjectDetails","projectName","transformProjectData","projects","project","transformDeliveryPhases","phases","phase","metrics","getTaskTypes","taskType","getProjects","getProjectTasksWithTypes","projectId","task","getProjectsWithTasks","createApiClient","erpnextApiUtils"],"mappings":"mCAQA,MAAMA,EAAW,cAGXC,EAAYC,EAAM,OAAO,CAC7B,QAASF,EACT,QAAS,IACT,QAAS,CACP,eAAgB,mBAChB,sBAAuB,OAAO,YAAc,EAChD,CACA,CAAC,EAGDC,EAAU,aAAa,QAAQ,IAC5BE,IAEK,OAAO,aACTA,EAAO,QAAQ,qBAAqB,EAAI,OAAO,YAIjDA,EAAO,QAAQ,OAAY,mBAC3BA,EAAO,QAAQ,cAAc,EAAI,mBAGjC,OAAOA,EAAO,QAAQ,OAEfA,GAERC,GACQ,QAAQ,OAAOA,CAAK,CAE/B,EAGAH,EAAU,aAAa,SAAS,IAC7BI,GACQA,EAERD,GACQ,QAAQ,OAAOA,CAAK,CAE/B,EAMY,MAACE,EAAmB,SAAY,CAC1C,GAAI,CACF,MAAMD,EAAW,MAAMJ,EAAU,IAAI,6DAA6D,EAElG,GAAII,EAAS,MAAQA,EAAS,KAAK,QAAS,CAC1C,MAAME,EAAOF,EAAS,KAAK,QAG3B,MAAO,CACL,QAASE,EAAK,SAAW,GACzB,SAAUC,EAAsBD,EAAK,UAAY,CAAA,CAAE,EACnD,QAASE,EAAqBF,EAAK,SAAW,CAAA,CAAE,EAChD,iBAAkBA,EAAK,kBAAoB,CAAA,EAC3C,UAAWA,EAAK,SACxB,CACI,CAEA,MAAM,IAAI,MAAM,yBAAyB,CAE3C,OAASH,EAAO,CAEd,MAAO,CACL,QAAS,GACT,MAAOA,EAAM,SAAW,iCACxB,SAAU,CAAA,EACV,QAAS,CACP,eAAgB,EAChB,gBAAiB,EACjB,YAAa,EACb,gBAAiB,EACjB,mBAAoB,EACpB,cAAe,EACf,gBAAiB,CACzB,EACM,iBAAkB,CAAA,CACxB,CACE,CACF,EAOaM,EAAoB,MAAOC,GAAgB,CACtD,GAAI,CACF,MAAMN,EAAW,MAAMJ,EAAU,IAAI,+DAAgE,CACnG,OAAQ,CAAE,aAAcU,CAAW,CACzC,CAAK,EAED,GAAIN,EAAS,MAAQA,EAAS,KAAK,QAAS,CAC1C,MAAME,EAAOF,EAAS,KAAK,QAE3B,GAAIE,EAAK,QACP,MAAO,CACL,QAAS,GACT,QAASK,EAAqBL,EAAK,OAAO,CACpD,EAEQ,MAAM,IAAI,MAAMA,EAAK,OAAS,iCAAiC,CAEnE,CAEA,MAAM,IAAI,MAAM,yBAAyB,CAE3C,OAASH,EAAO,CACd,MAAO,CACL,QAAS,GACT,MAAOA,EAAM,SAAW,kCACxB,QAAS,IACf,CACE,CACF,EAOMI,EAAyBK,GACtBA,EAAS,IAAIC,GAAWF,EAAqBE,CAAO,CAAC,EAQxDF,EAAwBE,IACrB,CAEL,GAAIA,EAAQ,IAAMA,EAAQ,KAC1B,KAAMA,EAAQ,MAAQA,EAAQ,cAAgB,kBAC9C,aAAcA,EAAQ,cAAgBA,EAAQ,KAC9C,eAAgBA,EAAQ,gBAAkBA,EAAQ,QAAU,OAC5D,OAAQA,EAAQ,QAAUA,EAAQ,gBAAkB,OAGpD,OAAQA,EAAQ,QAAUA,EAAQ,UAAY,YAC9C,SAAUA,EAAQ,UAAYA,EAAQ,OACtC,aAAcA,EAAQ,cAAgB,WACtC,SAAUA,EAAQ,UAAY,SAG9B,SAAU,WAAWA,EAAQ,UAAYA,EAAQ,kBAAoB,CAAC,EACtE,iBAAkB,WAAWA,EAAQ,kBAAoBA,EAAQ,UAAY,CAAC,EAC9E,gBAAiB,WAAWA,EAAQ,iBAAmB,CAAC,EAGxD,WAAY,SAASA,EAAQ,YAAc,CAAC,EAC5C,YAAa,SAASA,EAAQ,aAAeA,EAAQ,YAAc,CAAC,EACpE,gBAAiB,SAASA,EAAQ,iBAAmB,CAAC,EAGtD,cAAeA,EAAQ,eAAiB,WACxC,aAAcA,EAAQ,cAAgBA,EAAQ,eAAiB,WAG/D,gBAAiBC,EAAwBD,EAAQ,iBAAmB,CAAA,CAAE,EACtE,eAAgBC,EAAwBD,EAAQ,iBAAmB,CAAA,CAAE,EAGrE,oBAAqBA,EAAQ,oBAC7B,kBAAmBA,EAAQ,kBAC3B,kBAAmBA,EAAQ,kBAC3B,gBAAiBA,EAAQ,gBAGzB,YAAaA,EAAQ,YACrB,WAAYA,EAAQ,WAGpB,wBAAyBA,EAAQ,yBAA2B,KAC5D,6BAA8BA,EAAQ,8BAAgC,KACtE,2BAA4BA,EAAQ,4BAA8B,KAGlE,MAAOA,EAAQ,OAAS,CAAA,CAC5B,GAQMC,EAA2BC,GACxBA,EAAO,IAAIC,IAAU,CAE1B,WAAYA,EAAM,WAClB,aAAcA,EAAM,cAAgBA,EAAM,KAC1C,eAAgBA,EAAM,gBAAkBA,EAAM,OAC9C,iBAAkB,WAAWA,EAAM,kBAAoBA,EAAM,UAAY,CAAC,EAC1E,cAAe,SAASA,EAAM,eAAiB,CAAC,EAGhD,WAAY,SAASA,EAAM,YAAc,CAAC,EAC1C,gBAAiB,SAASA,EAAM,iBAAmB,CAAC,EACpD,kBAAmB,SAASA,EAAM,mBAAqB,CAAC,EAGxD,KAAMA,EAAM,MAAQA,EAAM,aAC1B,OAAQA,EAAM,QAAUA,EAAM,eAC9B,SAAU,WAAWA,EAAM,UAAYA,EAAM,kBAAoB,CAAC,CACtE,EAAI,EAQER,EAAwBS,IACrB,CAEL,eAAgB,SAASA,EAAQ,gBAAkB,CAAC,EACpD,gBAAiB,SAASA,EAAQ,iBAAmB,CAAC,EACtD,eAAgB,SAASA,EAAQ,iBAAmBA,EAAQ,gBAAkB,CAAC,EAG/E,YAAa,SAASA,EAAQ,aAAe,CAAC,EAC9C,WAAY,SAASA,EAAQ,aAAeA,EAAQ,YAAc,CAAC,EACnE,gBAAiB,SAASA,EAAQ,iBAAmB,CAAC,EACtD,eAAgB,SAASA,EAAQ,iBAAmBA,EAAQ,gBAAkB,CAAC,EAG/E,mBAAoB,WAAWA,EAAQ,oBAAsB,CAAC,EAC9D,gBAAiB,WAAWA,EAAQ,iBAAmB,CAAC,EAGxD,cAAe,WAAWA,EAAQ,eAAiB,CAAC,EACpD,aAAc,WAAWA,EAAQ,eAAiBA,EAAQ,cAAgB,CAAC,CAC/E,GAOaC,EAAe,SAAY,CACtC,GAAI,CACF,MAAMd,EAAW,MAAMJ,EAAU,IAAI,yBAAyB,EAE9D,OAAII,EAAS,MAAQA,EAAS,KAAK,KAC1BA,EAAS,KAAK,KAAK,IAAIe,IAAa,CACzC,KAAMA,EAAS,KACf,YAAaA,EAAS,aAAe,GAAGA,EAAS,IAAI,QAC7D,EAAQ,EAGG,CAAA,CAET,MAAgB,CACd,MAAO,CAAA,CACT,CACF,EAMaC,EAAc,SAAY,CACrC,GAAI,CACF,MAAMhB,EAAW,MAAMJ,EAAU,IAAI,wBAAyB,CAC5D,OAAQ,CACN,OAAQ,KAAK,UAAU,CAAC,OAAQ,eAAgB,SAAU,WAAY,kBAAkB,CAAC,EACzF,QAAS,KAAK,UAAU,CAAC,CAAC,WAAY,IAAK,CAAC,CAAC,CAAC,CACtD,CACA,CAAK,EAED,OAAII,EAAS,MAAQA,EAAS,KAAK,KAC1BA,EAAS,KAAK,KAGhB,CAAA,CAET,MAAgB,CACd,MAAO,CAAA,CACT,CACF,EAOaiB,EAA2B,MAAOC,GAAc,CAC3D,GAAI,CAEF,MAAMlB,EAAW,MAAMJ,EAAU,IAAI,qBAAsB,CACzD,OAAQ,CACN,OAAQ,KAAK,UAAU,CACrB,OACA,UACA,SACA,WACA,UACA,YACA,iBACA,eACA,UACA,aACV,CAAS,EACD,QAAS,KAAK,UAAU,CACtB,CAAC,UAAW,IAAKsB,CAAS,CACpC,CAAS,EACD,kBAAmB,GAC3B,CACA,CAAK,EAED,OAAIlB,EAAS,MAAQA,EAAS,KAAK,KACnBA,EAAS,KAAK,KAAK,IAAImB,IAAS,CAC5C,GAAIA,EAAK,KACT,KAAMA,EAAK,KACX,QAASA,EAAK,QACd,OAAQA,EAAK,OACb,SAAUA,EAAK,SACf,QAASA,EAAK,QACd,UAAWA,EAAK,UAChB,SAAUA,EAAK,aACf,WAAYA,EAAK,eACjB,YAAaA,EAAK,QAAU,KAAK,MAAMA,EAAK,OAAO,EAAE,CAAC,EAAI,KAC1D,YAAaA,EAAK,WAC1B,EAAQ,EAKG,CAAA,CAET,MAAgB,CACd,MAAO,CAAA,CACT,CACF,EAGaC,EAAuBnB,EAMvBoB,EAAkB,SACtBzB,EAIT0B,EAAe,CACb,iBAAArB,EACA,kBAAAI,EACA,aAAAS,EACA,YAAAE,EACA,qBAAsBf,EACtB,yBAAAgB,EACA,gBAAAI,CACF"}